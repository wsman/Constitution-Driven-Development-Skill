# CDD Claude Code 统一集成配置
# 宪法依据: §101单一真理源原则、§102熵减原则、§102状态机公理、§309自动化任务原则

name: unified-cdd-integration-config
version: v2.0.0
description: CDD统一集成配置 - 整合集成配置、MCP配置和斜杠命令
type: unified-integration-configuration
maintainer: 科技部Claude Code集成团队
constitutional_basis:
  - "§101: 单一真理源原则 - 配置以本文件为唯一真理源"
  - "§102: 熵减原则 - 集成降低系统熵值"
  - "§102: 状态机公理 - 集成支持5状态工作流"
  - "§309: Claude Code自动化任务原则 - 优化自动化能力"
  - "§304: L2+项目强制使用原则 - 确保L2+项目合规"

# -----------------------------------------------------------------------------
# 集成架构
# -----------------------------------------------------------------------------

integration_architecture:
  architecture_type: "layered_integration"
  layers:
    - layer: "session_layer"
      description: "Claude Code会话层"
      components: ["user_interface", "session_manager", "context_loader"]
      
    - layer: "cdd_adapter_layer"
      description: "CDD适配器层"
      components: ["5_state_workflow_mapper", "tool_invocation_proxy", "constitutional_validator"]
      
    - layer: "cdd_core_layer"
      description: "CDD核心层"
      components: ["constitutional_audit", "entropy_calculation", "feature_generation"]

# -----------------------------------------------------------------------------
# MCP集成配置
# -----------------------------------------------------------------------------

mcp_integration:
  # 推荐MCP服务器
  recommended_servers:
    # 版本控制
    git:
      name: "Git MCP"
      package: "@modelcontextprotocol/server-git"
      description: "Git版本控制集成"
      constitutional_basis: ["§101", "§104"]
      installation: "claude mcp add git -- npx -y @modelcontextprotocol/server-git"
      capabilities:
        - "读取提交历史"
        - "查看文件差异"
        - "管理分支"
      permissions:
        allow:
          - "mcp__git__status"
          - "mcp__git__log"
          - "mcp__git__diff"
          - "mcp__git__branch_list"
        deny:
          - "mcp__git__push"  # 需要人工确认
          - "mcp__git__reset"

    github:
      name: "GitHub MCP"
      package: "@modelcontextprotocol/server-github"
      description: "GitHub API集成"
      constitutional_basis: ["§101", "§309"]
      installation: "claude mcp add github -- npx -y @modelcontextprotocol/server-github"
      capabilities:
        - "读取仓库信息"
        - "管理Issues"
        - "创建Pull Requests"
        - "查看Actions状态"
      permissions:
        allow:
          - "mcp__github__read_repo:OpenDoge/OpenDoge"
          - "mcp__github__list_issues"
          - "mcp__github__list_prs"
        deny:
          - "mcp__github__write_repo"  # 需要人工确认

    # 监控分析
    sentry:
      name: "Sentry MCP"
      package: "@modelcontextprotocol/server-sentry"
      description: "错误监控集成"
      constitutional_basis: ["§102", "§310"]
      installation: "claude mcp add sentry -- npx -y @modelcontextprotocol/server-sentry"
      capabilities:
        - "读取错误报告"
        - "分析性能问题"
        - "监控部署健康"
      permissions:
        allow:
          - "mcp__sentry__read_issues"
          - "mcp__sentry__read_events"
        deny:
          - "mcp__sentry__write_settings"

    # 数据存储 (严格权限)
    postgres:
      name: "PostgreSQL MCP"
      package: "@modelcontextprotocol/server-postgres"
      description: "PostgreSQL数据库集成"
      constitutional_basis: ["§200"]
      installation: |
        claude mcp add postgres --transport stdio \
          --env PG_CONNECTION_STRING=$PG_SECRET \
          -- npx -y @modelcontextprotocol/server-postgres
      capabilities:
        - "只读查询"
        - "Schema检查"
      permissions:
        allow:
          - "mcp__postgres__query:SELECT"
          - "mcp__postgres__schema"
        deny:
          - "mcp__postgres__write:*"
          - "mcp__postgres__query:INSERT"
          - "mcp__postgres__query:UPDATE"
          - "mcp__postgres__query:DELETE"
          - "mcp__postgres__query:DROP"

  # CDD专用MCP工具
  cdd_tools:
    cdd-audit-mcp:
      name: "CDD审计MCP"
      description: "CDD宪法审计工具MCP封装"
      tool_mapping:
        - "cdd_audit_gate1"
        - "cdd_audit_gate2"
        - "cdd_audit_gate3"
        - "cdd_audit_gate4"
      constitutional_basis: ["§300.3"]

    entropy-monitor-mcp:
      name: "熵值监控MCP"
      description: "系统熵值监控工具MCP封装"
      tool_mapping:
        - "measure_entropy"
        - "analyze_entropy_trend"
      constitutional_basis: ["§102"]

  # 权限配置模板
  permission_templates:
    developer:
      description: "开发者默认权限"
      allow:
        - "Read(departments/technology/**)"
        - "Read(memory_bank/**)"
        - "Write(library/**)"
        - "mcp__git__status"
        - "mcp__git__log"
        - "mcp__github__read_repo:*"
      deny:
        - "Write(memory_bank/t0_core/**)"
        - "Write(cabinet/**)"
        - "mcp__postgres__write:*"

    auditor:
      description: "审计者权限"
      allow:
        - "Read(**)"
        - "mcp__git__*"
        - "mcp__github__read_*"
        - "mcp__sentry__read_*"
      deny:
        - "Write(**)"

    admin:
      description: "管理员权限 (办公厅主任)"
      allow:
        - "Read(**)"
        - "Write(**)"
        - "mcp__**"
      deny: []

  # 安全配置
  security:
    sensitive_operations:
      - "git push"
      - "github create_pr"
      - "postgres write"
      - "file delete"
    
    audit_logging:
      enabled: true
      log_path: "~/.claude/audit.log"
      retention_days: 30
    
    rate_limits:
      mcp_calls_per_minute: 60
      file_operations_per_minute: 100

# -----------------------------------------------------------------------------
# 斜杠命令配置
# -----------------------------------------------------------------------------

slash_commands:
  # 核心工作流命令
  cdd-workflow:
    name: /cdd-workflow
    syntax: "/cdd-workflow <task_description>"
    description: 启动完整的CDD 5状态工作流
    constitutional_basis: ["§102", "§309", "§304"]
    examples:
      - command: "/cdd-workflow implement-user-authentication"
        description: "实现用户认证功能（自动执行A→E状态）"
      - command: "/cdd-workflow add-password-reset-feature"
        description: "添加密码重置功能"
    workflow_trigger:
      state: "A"
      auto_transition: true
      tools_invoked:
        - "cdd_feature"
        - "cdd_state_transition"
        - "cdd_audit"

  # 宪法检查命令
  constitution-check:
    name: /constitution-check
    syntax: "/constitution-check [--gate=1-4|all] [--format=json|text]"
    description: 执行宪法合规检查
    constitutional_basis: ["§101", "§102", "§300.3"]
    options:
      gate:
        description: "指定审计门（1-4或all）"
        default: "all"
        values: ["1", "2", "3", "4", "all"]
      format:
        description: "输出格式"
        default: "text"
        values: ["json", "text", "detailed"]
    examples:
      - command: "/constitution-check"
        description: "执行全部4门宪法审计"
      - command: "/constitution-check --gate=1"
        description: "仅执行Gate 1版本一致性检查"
      - command: "/constitution-check --gate=all --format=json"
        description: "JSON格式输出完整审计结果"
    tools_invoked:
      - "cdd_audit"
      - "cdd_constitution_check"

  # 熵值监控命令
  entropy-monitor:
    name: /entropy-monitor
    syntax: "/entropy-monitor [--optimize] [--threshold=0.7]"
    description: 监控和优化系统熵值
    constitutional_basis: ["§102"]
    options:
      optimize:
        description: "自动执行熵值优化"
        type: "flag"
      threshold:
        description: "熵值警告阈值"
        default: "0.7"
        type: "float"
    examples:
      - command: "/entropy-monitor"
        description: "显示当前系统熵值"
      - command: "/entropy-monitor --optimize"
        description: "监控并自动优化熵值"
      - command: "/entropy-monitor --threshold=0.5"
        description: "使用0.5作为警告阈值"
    tools_invoked:
      - "measure_entropy"

  # 代码审查命令
  code-review:
    name: /code-review
    syntax: "/code-review <path> [--standard=ds-060]"
    description: 执行代码审查
    constitutional_basis: ["§101", "§102", "§300.3"]
    options:
      standard:
        description: "审查标准"
        default: "ds-060"
        values: ["ds-060", "constitution", "all"]
    examples:
      - command: "/code-review src/auth/"
        description: "审查auth目录下的代码"
      - command: "/code-review src/components/Button.tsx --standard=constitution"
        description: "按宪法标准审查Button组件"
    tools_invoked:
      - "cdd_audit"

  # 检查点保存命令
  checkpoint-save:
    name: /checkpoint-save
    syntax: "/checkpoint-save [--note=<description>]"
    description: 保存当前工作流检查点
    constitutional_basis: ["§104"]
    options:
      note:
        description: "检查点备注"
        type: "string"
    examples:
      - command: "/checkpoint-save"
        description: "保存当前状态为检查点"
      - command: "/checkpoint-save --note='完成用户认证核心逻辑'"
        description: "带备注保存检查点"
    tools_invoked:
      - "claude_code_bridge.create_checkpoint"

  # 检查点恢复命令
  checkpoint-restore:
    name: /checkpoint-restore
    syntax: "/checkpoint-restore [--latest|<checkpoint_id>]"
    description: 恢复到指定检查点
    constitutional_basis: ["§104"]
    options:
      latest:
        description: "恢复到最新检查点"
        type: "flag"
    examples:
      - command: "/checkpoint-restore --latest"
        description: "恢复到最新检查点"
      - command: "/checkpoint-restore 20260219_120000"
        description: "恢复到指定ID的检查点"
    tools_invoked:
      - "claude_code_bridge.restore_checkpoint"

  # 特性生成命令
  feature-spec:
    name: /feature-spec
    syntax: "/feature-spec <feature_name> [--complexity=L1-L4]"
    description: 生成特性规格文档
    constitutional_basis: ["§101", "§309"]
    options:
      complexity:
        description: "功能复杂度等级"
        default: "L2"
        values: ["L1", "L2", "L3", "L4"]
    examples:
      - command: "/feature-spec user-authentication --complexity=L3"
        description: "生成L3复杂度的用户认证规格"
    tools_invoked:
      - "cdd_feature"

  # 状态转换命令
  state-transition:
    name: /state-transition
    syntax: "/state-transition <target_state>"
    description: 手动触发工作流状态转换
    constitutional_basis: ["§102", "§103"]
    valid_transitions:
      - from: "A"
        to: ["B"]
      - from: "B"
        to: ["C"]
      - from: "C"
        to: ["D"]
      - from: "D"
        to: ["E", "C"]
      - from: "E"
        to: ["A"]
    examples:
      - command: "/state-transition B"
        description: "从State A转换到State B"
      - command: "/state-transition C"
        description: "从State B转换到State C"
    tools_invoked:
      - "cdd_state_transition"

  # 主题检查命令
  theme-check:
    name: /theme-check
    syntax: "/theme-check <path> [--fix]"
    description: 检查§119 Nordic主题合规性
    constitutional_basis: ["§119"]
    options:
      fix:
        description: "自动修复硬编码颜色"
        type: "flag"
    examples:
      - command: "/theme-check src/"
        description: "检查src目录下的主题合规"
      - command: "/theme-check src/components/ --fix"
        description: "检查并自动修复主题违规"
    detection_patterns:
      - "#[0-9a-fA-F]{3,6}"
      - "rgb\\([0-9, ]+\\)"
      - "rgba\\([0-9, ]+\\)"

  # 零停机检查命令
  zero-downtime-check:
    name: /zero-downtime-check
    syntax: "/zero-downtime-check [--pre-deploy|--post-deploy]"
    description: 验证§310零停机部署合规
    constitutional_basis: ["§310"]
    options:
      pre-deploy:
        description: "部署前检查"
        type: "flag"
      post-deploy:
        description: "部署后检查"
        type: "flag"
    examples:
      - command: "/zero-downtime-check --pre-deploy"
        description: "部署前验证零停机条件"
      - command: "/zero-downtime-check --post-deploy"
        description: "部署后验证服务健康"

  # 命令分组
  command_groups:
    workflow:
      name: "工作流控制"
      commands: ["cdd-workflow", "state-transition", "checkpoint-save", "checkpoint-restore"]
    
    verification:
      name: "验证检查"
      commands: ["constitution-check", "entropy-monitor", "code-review", "theme-check", "zero-downtime-check"]
    
    generation:
      name: "文档生成"
      commands: ["feature-spec"]

  # 快捷别名
  aliases:
    "/cc": "/constitution-check"
    "/em": "/entropy-monitor"
    "/cr": "/code-review"
    "/cs": "/checkpoint-save"
    "/cw": "/cdd-workflow"

# -----------------------------------------------------------------------------
# 集成工作流
# -----------------------------------------------------------------------------

integration_workflows:
  session_startup_workflow:
    triggers: ["claude_code_session_start"]
    steps:
      - step: "load_constitutional_context"
        component: "constitutional_constraint_injection_hook"
        parameters:
          constraint_categories: "development_constraints"
          injection_target: "session_context"
          
      - step: "initialize_status_dashboard"
        component: "project_status_dashboard_hook"
        parameters:
          dashboard_mode: "compact_view"
          refresh_interval: 30
          
      - step: "attempt_checkpoint_recovery"
        component: "checkpoint_recovery_hook"
        parameters:
          auto_detection: true
          validation_strictness: "standard"

  state_transition_workflow:
    triggers: ["workflow_state_change"]
    steps:
      - step: "update_constitutional_constraints"
        component: "constitutional_constraint_injection_hook"
        parameters:
          based_on_new_state: true
          dynamic_adjustment: true
          
      - step: "update_status_dashboard"
        component: "project_status_dashboard_hook"
        parameters:
          highlight_state_change: true
          update_metrics: true
          
      - step: "create_state_checkpoint"
        component: "checkpoint_recovery_hook"
        parameters:
          checkpoint_type: "state_transition"
          retention: "important"

  error_handling_workflow:
    triggers: ["error_detected", "constitutional_violation"]
    steps:
      - step: "activate_error_handling"
        component: "error_handling_recovery_hook"
        parameters:
          error_classification: "automatic"
          immediate_response: true
          
      - step: "update_dashboard_alerts"
        component: "project_status_dashboard_hook"
        parameters:
          alert_type: "error_notification"
          visualization: "error_highlight"
          
      - step: "create_error_checkpoint"
        component: "checkpoint_recovery_hook"
        parameters:
          checkpoint_type: "error_recovery_point"
          retention: "critical"

# -----------------------------------------------------------------------------
# 宪法合规集成
# -----------------------------------------------------------------------------

constitutional_integration:
  article_101_integration:
    implementation: "单一真理源原则集成"
    components:
      - "constitutional_constraint_injection_hook"
      - "project_status_dashboard_hook"
    verification: "所有数据源引用Memory Bank"
    
  article_102_integration:
    implementation: "熵减原则集成"
    components:
      - "project_status_dashboard_hook"
      - "error_handling_recovery_hook"
    verification: "实时熵值监控和优化"
    
  article_141_integration:
    implementation: "状态机公理集成"
    components:
      - "checkpoint_recovery_hook"
      - "all_workflow_transitions"
    verification: "5状态工作流完整支持"
    
  article_313_integration:
    implementation: "Claude Code自动化原则集成"
    components:
      - "all_templates"
      - "all_workflows"
    verification: "所有操作通过Claude Code自动化"
    
  article_320_integration:
    implementation: "L2+项目强制使用原则集成"
    components:
      - "project_init_template"
      - "constitutional_compliance_template"
    verification: "L2+项目强制使用检查"

# -----------------------------------------------------------------------------
# 性能配置
# -----------------------------------------------------------------------------

performance_configuration:
  data_caching:
    enabled: true
    cache_layers:
      - layer: "memory_cache"
        size: "100MB"
        ttl: "300秒"
        
      - layer: "disk_cache"
        size: "1GB"
        ttl: "3600秒"
        
    cache_invalidation:
      triggers: ["constitutional_change", "state_transition", "manual_invalidation"]

  real_time_updates:
    enabled: true
    update_intervals:
      dashboard_updates: "30秒"
      entropy_monitoring: "60秒"
      constitutional_checks: "实时"
      state_monitoring: "5秒"
      
    optimization_techniques:
      - "delta_updates"
      - "lazy_loading"
      - "progressive_enhancement"

# -----------------------------------------------------------------------------
# 监控与审计
# -----------------------------------------------------------------------------

monitoring_and_audit:
  integration_health_monitoring:
    metrics:
      - "hook_execution_success_rate"
      - "workflow_completion_rate"
      - "template_utilization"
      - "performance_latency"
      
    thresholds:
      success_rate_warning: 90%
      success_rate_critical: 80%
      latency_warning: "2秒"
      latency_critical: "5秒"

  constitutional_audit_points:
    audit_triggers:
      - "integration_configuration_change"
      - "hook_execution"
      - "workflow_transition"
      - "template_application"
      
    audit_requirements:
      - "所有集成操作必须记录"
      - "宪法合规必须验证"
      - "熵值影响必须评估"
      - "性能指标必须监控"

# -----------------------------------------------------------------------------
# 错误处理和恢复
# -----------------------------------------------------------------------------

error_handling:
  integration_error_categories:
    configuration_errors:
      handling: "自动回滚到上次有效配置"
      escalation: "通知系统管理员"
      
    hook_execution_errors:
      handling: "优雅降级到安全模式"
      escalation: "使用备用钩子或跳过"
      
    workflow_errors:
      handling: "状态回滚和恢复"
      escalation: "人工干预和调整"
      
    constitutional_errors:
      handling: "立即阻止操作"
      escalation: "宪法审计和修复"

  recovery_strategies:
    automatic_recovery:
      enabled: true
      strategies:
        - "retry_with_exponential_backoff"
        - "fallback_to_simplified_mode"
        - "rollback_to_last_valid_state"
        
    manual_recovery:
      enabled: true
      guidance:
        - "step_by_step_recovery_wizard"
        - "expert_intervention_request"
        - "constitutional_review_process"

# -----------------------------------------------------------------------------
# 部署配置
# -----------------------------------------------------------------------------

deployment_configuration:
  environment_requirements:
    claude_code_version: ">= 2.0.0"
    cdd_framework_version: "1.7.0"
    python_version: ">= 3.9"
    system_resources:
      memory: ">= 2GB"
      storage: ">= 100MB"
      network: "稳定连接"

  initialization_procedure:
    steps:
      - "验证环境要求"
      - "加载宪法约束"
      - "初始化集成组件"
      - "启动监控系统"
      - "运行自检程序"

  validation_checklist:
    - "环境要求验证通过"
    - "宪法约束加载成功"
    - "所有钩子初始化完成"
    - "工作流模板加载就绪"
    - "监控系统启动正常"
    - "自检程序全部通过"

# -----------------------------------------------------------------------------
# 版本控制
# -----------------------------------------------------------------------------

version_control:
  current_version: "v2.0.0"
  version_policy: "语义化版本控制"
  
  backward_compatibility:
    major_version: "不兼容变更"
    minor_version: "向后兼容的功能新增"
    patch_version: "向后兼容的错误修复"
  
  upgrade_procedure:
    automatic_updates:
      enabled: false
      notification: "手动批准后更新"
      
    manual_updates:
      procedure:
        - "备份当前配置"
        - "验证新版本兼容性"
        - "逐步迁移配置"
        - "运行迁移后验证"

# -----------------------------------------------------------------------------
# 宪法合规声明
# -----------------------------------------------------------------------------

constitutional_compliance:
  compliance_statement: |
    本集成配置严格遵循OpenDoge宪法约束，确保所有集成操作：
    1. 基于Memory Bank作为单一真理源（§101）
    2. 降低或维持系统熵值（§102）
    3. 支持5状态工作流完整执行（§102）
    4. 优化Claude Code自动化能力（§309）
    5. 确保L2+项目强制使用合规（§304）
    
  verification_requirements:
    - "每次集成操作前验证宪法约束"
    - "实时监控宪法合规状态"
    - "定期进行宪法合规审计"
    - "记录所有宪法相关事件"
    
  violation_handling:
    - "宪法违规操作自动阻止"
    - "违规事件立即记录审计日志"
    - "系统管理员实时通知"
    - "纠正措施自动建议"

# -----------------------------------------------------------------------------
# 版本历史
# -----------------------------------------------------------------------------

version_history:
  v2.0.0:
    date: "2026-02-19"
    changes:
      - "统一集成配置"
      - "整合MCP配置和斜杠命令配置"
      - "性能优化和宪法合规增强"
      - "简化配置架构"
    constitutional_basis_verified: true
    entropy_impact_assessment: "ΔH_sys = -0.02 (符合§100.3)"
    integration_coverage: "完整集成系统配置"

# 文件状态
file_status:
  status: "活跃"
  constitutional_level: "T2 标准层 (集成配置)"
  maintenance_policy: "持续维护，宪法驱动更新"