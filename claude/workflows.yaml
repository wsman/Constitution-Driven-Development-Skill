# 统一工作流配置
# 宪法依据: §102状态机公理、§103审批状态转换、§309自动化任务原则

name: unified-cdd-workflows
version: v2.0.0
description: CDD统一工作流配置 - 整合5状态工作流自动化转换
type: workflows-configuration
maintainer: 科技部CDD集成团队
constitutional_basis:
  - "§102: 状态机公理 - 强制状态转换"
  - "§103: 审批状态转换 - 需要明确批准"
  - "§309: Claude Code自动化任务原则 - 自动化编码会话"
  - "§101: 单一真理源原则 - 引用Memory Bank文档"
  - "§102: 熵减原则 - 评估熵值影响"

# -----------------------------------------------------------------------------
# 工作流定义
# -----------------------------------------------------------------------------

workflows:
  # State A → B 自动转换工作流
  state_a_to_b_transition:
    name: state-a-to-b-transition
    version: v1.0.0
    description: 智能接收任务并自动生成特性规格（State A → B）
    enabled: true
    trigger:
      - state_a_completed
      - manual_trigger
    constitutional_basis:
      - "§102: 状态机公理 - 强制状态转换"
      - "§103: 审批状态转换 - 需要明确批准"
      - "§101: 单一真理源原则 - 引用Memory Bank文档"
      - "§102: 熵减原则 - 评估任务熵值影响"
    
    # 工作流定义
    workflow:
      # 阶段1: State A 任务接收与分析
      phase_1_state_a_analysis:
        name: "State A: 任务接收与分析"
        steps:
          - id: load_project_context
            action: load_context
            parameters:
              context_sources:
                - memory_bank/t0_core/active_context.md
                - memory/YYYY-MM-DD.md
                - memory/entropy_history.json
            success_criteria: "成功加载至少2个上下文源"
            constitutional_check: "§101"
          
          - id: analyze_task_requirements
            action: analyze_task
            parameters:
              task_input: "{{user_input}}"
              complexity_assessment: true
              constitutional_impact: true
            success_criteria: "完成任务复杂度评估和宪法影响分析"
            constitutional_check: "§102, §309"
          
          - id: record_state_a
            action: record_state_transition
            parameters:
              from_state: "none"
              to_state: "A"
              timestamp: "{{current_timestamp}}"
              task_summary: "{{task_analysis_result}}"
            success_criteria: "状态转换记录成功保存"
            constitutional_check: "§104"
        
        completion_conditions:
          - "context_loaded": true
          - "task_analyzed": true
          - "state_recorded": true
      
      # 阶段2: State A → B 转换准备
      phase_2_transition_preparation:
        name: "State A → B 转换准备"
        depends_on: phase_1_state_a_analysis
        
        steps:
          - id: generate_feature_spec_template
            action: generate_spec_template
            parameters:
              task_complexity: "{{assessed_complexity}}"
              template_type: "t2_specification"
              include_constitutional_checks: true
            success_criteria: "特性规格模板生成"
            constitutional_check: "§101"
          
          - id: populate_spec_with_context
            action: populate_spec
            parameters:
              template: "{{generated_template}}"
              context_data: "{{loaded_context}}"
              task_requirements: "{{analyzed_task}}"
            success_criteria: "模板填充完成，包含完整上下文"
            constitutional_check: "§101"
          
          - id: calculate_entropy_baseline
            action: measure_entropy
            parameters:
              detailed: true
              compare_with_history: true
            success_criteria: "熵值基线测量完成，ΔH_sys计算"
            constitutional_check: "§102"
          
          - id: predict_entropy_impact
            action: predict_entropy_impact
            parameters:
              proposed_changes: "{{feature_spec}}"
              baseline_entropy: "{{current_entropy}}"
              historical_patterns: "{{entropy_history}}"
            success_criteria: "熵值影响预测完成，ΔH_sys预测值"
            constitutional_check: "§102"
        
        completion_conditions:
          - "spec_template_generated": true
          - "spec_populated": true
          - "entropy_baseline_measured": true
          - "entropy_impact_predicted": true
      
      # 阶段3: State B 特性规格生成
      phase_3_state_b_specification:
        name: "State B: 特性规格生成"
        depends_on: phase_2_transition_preparation
        
        steps:
          - id: generate_t2_specification
            action: generate_t2_spec
            parameters:
              task_analysis: "{{task_analysis_result}}"
              context_data: "{{loaded_context}}"
              entropy_analysis: "{{entropy_analysis}}"
              constitutional_constraints: "{{applicable_constraints}}"
            success_criteria: "生成完整的T2特性规格文档"
            constitutional_check: "§101, §309"
          
          - id: apply_constitutional_checks
            action: apply_constitutional_checks
            parameters:
              specification: "{{generated_spec}}"
              checks:
                - "§101: 单一真理源引用检查"
                - "§102: 熵值影响合规检查"
                - "§119: 主题驱动开发检查"
                - "§310: 零停机协议检查"
                - "§309: Claude Code合规检查"
            success_criteria: "所有宪法检查通过"
            constitutional_check: "§101-§304"
          
          - id: generate_approval_request
            action: generate_approval_request
            parameters:
              specification: "{{checked_spec}}"
              constitutional_compliance: "{{constitutional_check_results}}"
              entropy_impact: "{{predicted_entropy_impact}}"
              approval_authority: "办公厅主任"
            success_criteria: "审批请求生成，包含所有必要信息"
            constitutional_check: "§103"
          
          - id: record_state_b
            action: record_state_transition
            parameters:
              from_state: "A"
              to_state: "B"
              timestamp: "{{current_timestamp}}"
              specification: "{{generated_spec}}"
              approval_request_id: "{{approval_request_id}}"
            success_criteria: "State B记录成功保存"
            constitutional_check: "§104"
        
        completion_conditions:
          - "t2_spec_generated": true
          - "constitutional_checks_passed": true
          - "approval_request_generated": true
          - "state_b_recorded": true

  # State B → C 无缝转换工作流
  state_b_to_c_transition:
    name: state-b-to-c-transition
    version: v1.0.0
    description: 批准后的特性规格自动加载到编码会话（State B → C）
    enabled: true
    trigger:
      - approval_granted
      - auto_approval_conditions_met
    constitutional_basis:
      - "§102: 状态机公理 - 强制状态转换"
      - "§103: 审批状态转换 - 基于批准的状态转换"
      - "§309: Claude Code自动化任务原则 - 自动化编码会话"
      - "§304: L2+项目强制使用原则 - 确保Claude Code使用"
      - "§101: 单一真理源原则 - 引用批准的规格文档"
    
    # 工作流定义
    workflow:
      # 阶段1: 批准验证和环境准备
      phase_1_approval_verification:
        name: "State B: 批准验证和环境准备"
        steps:
          - id: verify_approval_status
            action: verify_approval
            parameters:
              approval_request_id: "{{approval_request_id}}"
              required_authority: "办公厅主任"
              check_expiry: true
            success_criteria: "批准状态验证通过，未过期"
            constitutional_check: "§103"
          
          - id: load_approved_specification
            action: load_specification
            parameters:
              spec_reference: "{{approved_spec_reference}}"
              include_attachments: true
              verify_integrity: true
            success_criteria: "特性规格文档完整加载，完整性验证通过"
            constitutional_check: "§101"
          
          - id: initialize_claude_code_session
            action: initialize_session
            parameters:
              session_type: "development"
              complexity_level: "{{spec_complexity}}"
              constitutional_constraints: "{{spec_constitutional_constraints}}"
              entropy_constraints: "{{spec_entropy_constraints}}"
            success_criteria: "Claude Code开发会话初始化完成"
            constitutional_check: "§309, §304"
          
          - id: configure_development_environment
            action: configure_environment
            parameters:
              tech_stack: "{{spec_tech_stack}}"
              dependencies: "{{spec_dependencies}}"
              testing_framework: "{{spec_testing_framework}}"
              monitoring_tools: "{{spec_monitoring_tools}}"
            success_criteria: "开发环境配置完成，所有工具就绪"
            constitutional_check: "§309"
        
        completion_conditions:
          - "approval_verified": true
          - "spec_loaded": true
          - "session_initialized": true
          - "environment_configured": true
      
      # 阶段2: State B → C 智能转换
      phase_2_intelligent_transition:
        name: "State B → C 智能转换"
        depends_on: phase_1_approval_verification
        
        steps:
          - id: analyze_implementation_complexity
            action: analyze_complexity
            parameters:
              specification: "{{loaded_spec}}"
              decomposition_strategy: "modular"
              estimation_model: "cdd_complexity_model"
            success_criteria: "实现复杂度分析完成，分解为可执行模块"
            constitutional_check: "§309"
          
          - id: generate_implementation_plan
            action: generate_implementation_plan
            parameters:
              modules: "{{analyzed_modules}}"
              dependencies: "{{module_dependencies}}"
              sequence: "optimal_implementation_sequence"
              risk_assessment: true
            success_criteria: "生成详细实现计划，包含依赖关系和风险分析"
            constitutional_check: "§309"
          
          - id: setup_real_time_monitoring
            action: setup_monitoring
            parameters:
              entropy_monitoring: true
              constitutional_compliance: true
              code_quality: true
              performance: true
            success_criteria: "实时监控系统就绪，所有监控点激活"
            constitutional_check: "§102, §104"
          
          - id: record_state_transition
            action: record_state_transition
            parameters:
              from_state: "B"
              to_state: "C"
              timestamp: "{{current_timestamp}}"
              approval_reference: "{{approval_request_id}}"
              implementation_plan: "{{generated_plan}}"
            success_criteria: "状态转换记录成功保存"
            constitutional_check: "§104"
        
        completion_conditions:
          - "complexity_analyzed": true
          - "implementation_plan_generated": true
          - "monitoring_setup": true
          - "transition_recorded": true
      
      # 阶段3: State C 编码会话启动
      phase_3_state_c_execution_start:
        name: "State C: 编码会话启动"
        depends_on: phase_2_intelligent_transition
        
        steps:
          - id: activate_claude_code_tools
            action: activate_tools
            parameters:
              tools:
                - "code_generation"
                - "code_review"
                - "testing_generation"
                - "documentation_generation"
                - "constitutional_audit"
              integration_level: "deep"
            success_criteria: "所有Claude Code工具激活，深度集成就绪"
            constitutional_check: "§309"
          
          - id: load_constitutional_constraints
            action: load_constraints
            parameters:
              constraints: "{{spec_constitutional_constraints}}"
              enforcement_level: "strict"
              real_time_validation: true
            success_criteria: "宪法约束加载完成，实时验证激活"
            constitutional_check: "§101-§304"
          
          - id: configure_entropy_aware_coding
            action: configure_entropy_awareness
            parameters:
              baseline_entropy: "{{spec_baseline_entropy}}"
              allowed_increase: "{{spec_allowed_entropy_increase}}"
              real_time_monitoring: true
              auto_optimization: true
            success_criteria: "熵值感知编码配置完成，实时监控和自动优化激活"
            constitutional_check: "§102"
          
          - id: start_development_session
            action: start_session
            parameters:
              session_id: "DEV-{{timestamp}}"
              module_sequence: "{{implementation_plan_sequence}}"
              constitutional_guard: true
              entropy_guard: true
            success_criteria: "开发会话正式启动，宪法和熵值守卫激活"
            constitutional_check: "§102, §309"
        
        completion_conditions:
          - "tools_activated": true
          - "constraints_loaded": true
          - "entropy_awareness_configured": true
          - "session_started": true

  # State C → D 验证自动化工作流
  state_c_to_d_verification:
    name: state-c-to-d-verification
    version: v1.0.0
    description: 一键执行完整宪法审计和验证（State C → D）
    enabled: true
    trigger:
      - development_completed
      - manual_audit_request
      - quality_gate_triggered
    constitutional_basis:
      - "§102: 状态机公理 - 强制状态转换"
      - "§300.3: 4门宪法审计 - 强制验证机制"
      - "§102: 熵减原则 - 验证熵值变化"
      - "§101: 单一真理源原则 - 验证文档同步"
      - "§104: 持久化原则 - 审计记录保存"
    
    # 工作流定义
    workflow:
      # 阶段1: 验证准备和基线收集
      phase_1_verification_preparation:
        name: "验证准备和基线收集"
        steps:
          - id: collect_development_artifacts
            action: collect_artifacts
            parameters:
              artifacts:
                - "generated_code"
                - "test_results"
                - "documentation_updates"
                - "session_logs"
                - "entropy_measurements"
              integrity_check: true
            success_criteria: "所有开发产物收集完成，完整性检查通过"
            constitutional_check: "§104"
          
          - id: load_original_specification
            action: load_original_spec
            parameters:
              spec_reference: "{{original_spec_reference}}"
              include_approval_context: true
            success_criteria: "原始特性规格完整加载，包含批准上下文"
            constitutional_check: "§101"
          
          - id: establish_verification_baseline
            action: establish_baseline
            parameters:
              original_entropy: "{{spec_baseline_entropy}}"
              original_constraints: "{{original_constitutional_constraints}}"
              original_requirements: "{{original_requirements}}"
            success_criteria: "验证基线建立完成，包含原始状态数据"
            constitutional_check: "§102"
          
          - id: initialize_audit_environment
            action: initialize_audit_env
            parameters:
              audit_type: "4_gate_constitutional_audit"
              tools:
                - "cdd_audit_tool"
                - "measure_entropy_tool"
                - "code_quality_analyzer"
                - "documentation_validator"
            success_criteria: "审计环境初始化完成，所有审计工具就绪"
            constitutional_check: "§300.3"
        
        completion_conditions:
          - "artifacts_collected": true
          - "spec_loaded": true
          - "baseline_established": true
          - "audit_environment_ready": true
      
      # 阶段2: 4门宪法审计执行
      phase_2_four_gate_audit:
        name: "4门宪法审计执行"
        depends_on: phase_1_verification_preparation
        
        steps:
          - id: execute_gate_1_version_consistency
            action: execute_gate_audit
            parameters:
              gate: "gate_1"
              audit_focus: "version_consistency"
              checks:
                - "代码与文档版本一致性"
                - "配置与规范一致性"
                - "依赖版本兼容性"
              strict_mode: true
            success_criteria: "Gate 1审计完成，版本一致性验证通过"
            constitutional_check: "§101"
          
          - id: execute_gate_2_behavior_validation
            action: execute_gate_audit
            parameters:
              gate: "gate_2"
              audit_focus: "behavior_validation"
              checks:
                - "功能行为符合规格"
                - "错误处理完整性"
                - "性能要求满足"
                - "安全约束合规"
            success_criteria: "Gate 2审计完成，行为验证通过"
            constitutional_check: "§300.3"
          
          - id: execute_gate_3_entropy_verification
            action: execute_gate_audit
            parameters:
              gate: "gate_3"
              audit_focus: "entropy_verification"
              checks:
                - "实际熵值测量"
                - "熵值变化分析"
                - "热点识别和评估"
                - "§102合规性验证"
            success_criteria: "Gate 3审计完成，熵值验证通过，ΔH_sys计算"
            constitutional_check: "§102"
          
          - id: execute_gate_4_semantic_audit
            action: execute_gate_audit
            parameters:
              gate: "gate_4"
              audit_focus: "semantic_audit"
              checks:
                - "宪法约束语义一致性"
                - "代码意图与规格对齐"
                - "架构模式合规性"
                - "技术债务评估"
            success_criteria: "Gate 4审计完成，语义审计通过"
            constitutional_check: "§300.3"
        
        completion_conditions:
          - "gate_1_completed": true
          - "gate_2_completed": true
          - "gate_3_completed": true
          - "gate_4_completed": true
      
      # 阶段3: 综合验证和决策
      phase_3_comprehensive_verification:
        name: "综合验证和决策"
        depends_on: phase_2_four_gate_audit
        
        steps:
          - id: consolidate_audit_results
            action: consolidate_results
            parameters:
              gate_results:
                - "{{gate_1_results}}"
                - "{{gate_2_results}}"
                - "{{gate_3_results}}"
                - "{{gate_4_results}}"
              weighting: "constitutional_priority_weighting"
            success_criteria: "审计结果整合完成，优先级加权计算"
            constitutional_check: "§300.3"
          
          - id: calculate_entropy_compliance
            action: calculate_entropy_compliance
            parameters:
              baseline_entropy: "{{original_entropy}}"
              final_entropy: "{{measured_final_entropy}}"
              delta_threshold: "{{allowed_entropy_increase}}"
              §102_requirement: "ΔH_sys ≤ 0"
            success_criteria: "熵值合规性计算完成，§102合规状态确定"
            constitutional_check: "§102"
          
          - id: generate_verification_report
            action: generate_verification_report
            parameters:
              audit_results: "{{consolidated_results}}"
              entropy_compliance: "{{entropy_compliance}}"
              constitutional_status: "{{constitutional_status}}"
              recommendations: true
            success_criteria: "综合验证报告生成，包含详细分析和建议"
            constitutional_check: "§104"
          
          - id: make_state_transition_decision
            action: make_transition_decision
            parameters:
              verification_results: "{{verification_report}}"
              decision_criteria:
                - "所有4门审计通过"
                - "§102熵减原则合规"
                - "无严重宪法违规"
                - "质量指标达标"
              auto_approval_threshold: "high_confidence"
            success_criteria: "状态转换决策完成，明确的通过/失败决定"
            constitutional_check: "§102"
        
        completion_conditions:
          - "results_consolidated": true
          - "entropy_compliance_calculated": true
          - "verification_report_generated": true
          - "transition_decision_made": true
      
      # 阶段4: State D 验证状态记录
      phase_4_state_d_verification_record:
        name: "State D: 验证状态记录"
        depends_on: phase_3_comprehensive_verification
        
        steps:
          - id: record_verification_outcome
            action: record_verification
            parameters:
              verification_id: "VER-{{timestamp}}"
              outcome: "{{transition_decision}}"
              gate_results: "{{gate_results_summary}}"
              entropy_compliance: "{{entropy_compliance_details}}"
              constitutional_status: "{{constitutional_status_summary}}"
            success_criteria: "验证结果记录保存"
            constitutional_check: "§104"
          
          - id: update_project_context
            action: update_context
            parameters:
              context_updates:
                - "verification_status"
                - "entropy_state"
                - "constitutional_compliance"
                - "quality_metrics"
              sync_with_memory_bank: true
            success_criteria: "项目上下文更新完成，与Memory Bank同步"
            constitutional_check: "§101"
          
          - id: generate_remediation_plan_if_needed
            action: generate_remediation_plan
            parameters:
              condition: "{{transition_decision}} == 'failed'"
              issues: "{{identified_issues}}"
              priority: "based_on_constitutional_severity"
              timeline: "immediate_to_7_days"
            success_criteria: "如验证失败，生成修复计划"
            constitutional_check: "§300.3"
          
          - id: record_state_transition
            action: record_state_transition
            parameters:
              from_state: "C"
              to_state: "D"
              timestamp: "{{current_timestamp}}"
              verification_reference: "{{verification_id}}"
              transition_decision: "{{transition_decision}}"
            success_criteria: "状态转换记录成功保存"
            constitutional_check: "§104"
        
        completion_conditions:
          - "verification_recorded": true
          - "context_updated": true
          - "remediation_plan_generated_if_needed": true
          - "transition_recorded": true

  # State D → E 闭环完成工作流
  state_d_to_e_closing:
    name: state-d-to-e-closing
    version: v1.0.0
    description: 完成开发闭环，创建检查点和更新项目状态（State D → E）
    enabled: true
    trigger:
      - verification_passed
      - manual_close_request
    constitutional_basis:
      - "§102: 状态机公理 - 强制状态转换"
      - "§104: 持久化原则 - 完整审计记录"
      - "§101: 单一真理源原则 - 更新Memory Bank"
      - "§102: 熵减原则 - 最终熵值确认"
    
    # 工作流定义
    workflow:
      # 阶段1: 闭环准备和最终验证
      phase_1_closure_preparation:
        name: "闭环准备和最终验证"
        steps:
          - id: verify_all_gates_passed
            action: verify_gates
            parameters:
              gate_status: "{{verification_gate_status}}"
              required_gates: [1, 2, 3, 4]
            success_criteria: "确认所有4门宪法审计通过"
            constitutional_check: "§300.3"
          
          - id: final_entropy_confirmation
            action: confirm_entropy
            parameters:
              baseline_entropy: "{{original_entropy}}"
              final_entropy: "{{measured_entropy}}"
              §102_requirement: "ΔH_sys ≤ 0"
              tolerance: "none"
            success_criteria: "最终熵值确认，§102合规验证通过"
            constitutional_check: "§102"
          
          - id: document_synchronization_verification
            action: verify_document_sync
            parameters:
              code_references: "{{code_documentation_references}}"
              document_status: "{{documentation_completeness}}"
              sync_requirements: "100%"
            success_criteria: "文档同步验证通过，代码与文档100%同步"
            constitutional_check: "§101"
          
          - id: constitutional_compliance_final_check
            action: final_constitutional_check
            parameters:
              constraints: "{{applied_constraints}}"
              violations: "{{detected_violations}}"
              resolution_status: "all_resolved"
            success_criteria: "宪法合规最终检查通过，所有违规已解决"
            constitutional_check: "§101-§304"
        
        completion_conditions:
          - "gates_verified": true
          - "entropy_confirmed": true
          - "document_sync_verified": true
          - "constitutional_compliance_verified": true
      
      # 阶段2: 项目状态更新和归档
      phase_2_project_state_update:
        name: "项目状态更新和归档"
        depends_on: phase_1_closure_preparation
        
        steps:
          - id: update_active_context
            action: update_active_context
            parameters:
              context_changes:
                - "状态: E (已完成)"
                - "完成时间: {{completion_timestamp}}"
                - "最终熵值: {{final_entropy}}"
                - "宪法合规状态: {{constitutional_compliance_status}}"
                - "验证参考: {{verification_reference}}"
              sync_immediate: true
            success_criteria: "活动上下文更新完成，立即同步到Memory Bank"
            constitutional_check: "§101"
          
          - id: archive_development_artifacts
            action: archive_artifacts
            parameters:
              artifacts_to_archive:
                - "开发代码"
                - "测试结果"
                - "审计报告"
                - "会议记录"
                - "熵值测量数据"
              retention_policy: "7年"
              access_control: "read_only"
            success_criteria: "开发产物归档完成，设置7年保留期"
            constitutional_check: "§104"
          
          - id: create_completion_checkpoint
            action: create_checkpoint
            parameters:
              checkpoint_type: "completion"
              state: "E"
              includes:
                - "完整代码库快照"
                - "所有测试结果"
                - "完整审计轨迹"
                - "最终熵值状态"
                - "宪法合规证书"
            success_criteria: "完成检查点创建，包含完整项目状态"
            constitutional_check: "§104"
          
          - id: notify_stakeholders
            action: notify_stakeholders
            parameters:
              stakeholders:
                - "办公厅主任"
                - "科技部负责人"
                - "项目团队"
              notification_type: "completion_summary"
              include_reports: true
            success_criteria: "利益相关者通知发送完成"
            constitutional_check: "§104"
        
        completion_conditions:
          - "context_updated": true
          - "artifacts_archived": true
          - "checkpoint_created": true
          - "stakeholders_notified": true
      
      # 阶段3: State E 最终记录和循环重启
      phase_3_state_e_final_record:
        name: "State E: 最终记录和循环重启"
        depends_on: phase_2_project_state_update
        
        steps:
          - id: generate_final_summary_report
            action: generate_summary_report
            parameters:
              project_summary:
                - "项目名称: {{project_name}}"
                - "完成功能: {{feature_name}}"
                - "开发时长: {{development_duration}}"
                - "最终熵值: ΔH_sys = {{entropy_delta}}"
                - "宪法合规: {{constitutional_compliance_rate}}%"
                - "代码质量: {{code_quality_score}}"
                - "测试覆盖率: {{test_coverage}}%"
              recommendations: "future_improvements"
            success_criteria: "最终总结报告生成，包含项目绩效和改进建议"
            constitutional_check: "§104"
          
          - id: record_state_e_completion
            action: record_state_completion
            parameters:
              state: "E"
              completion_timestamp: "{{current_timestamp}}"
              summary_report: "{{final_summary_report}}"
              constitutional_certificate: "{{constitutional_compliance_certificate}}"
            success_criteria: "State E完成记录保存"
            constitutional_check: "§104"
          
          - id: reset_for_next_cycle
            action: reset_for_next_cycle
            parameters:
              reset_state: "A"
              preserve_context: true
              cleanup_temporary: true
              initialize_next_session: true
            success_criteria: "系统重置完成，准备下一个开发周期"
            constitutional_check: "§102"
          
          - id: record_full_workflow_cycle
            action: record_workflow_cycle
            parameters:
              cycle_id: "CYCLE-{{timestamp}}"
              states_completed: ["A", "B", "C", "D", "E"]
              duration: "{{total_duration}}"
              constitutional_violations: "{{total_violations}}"
              entropy_impact: "{{total_entropy_impact}}"
            success_criteria: "完整工作流周期记录保存"
            constitutional_check: "§104"
        
        completion_conditions:
          - "summary_report_generated": true
          - "completion_recorded": true
          - "system_reset": true
          - "workflow_cycle_recorded": true

# -----------------------------------------------------------------------------
# 工作流状态机配置
# -----------------------------------------------------------------------------

state_machine_configuration:
  states:
    A: 
      name: "Intake"
      description: "任务接收和分析"
      allowed_transitions: ["B"]
      required_approval: false
      
    B:
      name: "Plan"
      description: "特性规格生成和审批"
      allowed_transitions: ["C"]
      required_approval: true
      
    C:
      name: "Execute"
      description: "编码实现"
      allowed_transitions: ["D"]
      required_approval: false
      
    D:
      name: "Verify"
      description: "宪法审计和验证"
      allowed_transitions: ["E", "C"]
      required_approval: false
      
    E:
      name: "Close"
      description: "完成闭环"
      allowed_transitions: ["A"]
      required_approval: false

  transition_validation:
    constitutional_requirements:
      - "§102: 状态转换必须遵循状态机公理"
      - "§103: 状态B→C需要明确审批"
      - "§102: 所有转换必须评估熵值影响"
      - "§101: 状态记录必须同步到Memory Bank"

  error_recovery_transitions:
    from_state: "D"
    to_state: "C"
    condition: "verification_failed"
    description: "验证失败时回到State C进行修复"

# -----------------------------------------------------------------------------
# 性能配置
# -----------------------------------------------------------------------------

performance_configuration:
  workflow_execution:
    timeout_per_phase: 30  # 分钟
    max_concurrent_workflows: 2
    retry_policy:
      max_attempts: 3
      backoff_delay: "5分钟"
      exponential_backoff: true
  
  state_transition_optimization:
    cached_state_validation: true
    precomputed_transitions: true
    incremental_validation: true

# -----------------------------------------------------------------------------
# 监控与审计
# -----------------------------------------------------------------------------

monitoring_and_audit:
  workflow_execution_monitoring:
    metrics:
      - "workflow_completion_rate"
      - "state_transition_success_rate"
      - "average_transition_time"
      - "error_rate_per_workflow"
    
    thresholds:
      completion_rate_warning: 90%
      completion_rate_critical: 80%
      transition_time_warning: "10分钟"
      transition_time_critical: "30分钟"
  
  constitutional_audit_points:
    audit_triggers:
      - "state_transition_initiated"
      - "workflow_completed"
      - "constitutional_violation_detected"
    
    audit_requirements:
      - "状态转换宪法合规验证"
      - "工作流执行完整性检查"
      - "熵值影响记录验证"

# -----------------------------------------------------------------------------
# 版本历史
# -----------------------------------------------------------------------------

version_history:
  v2.0.0:
    date: "2026-02-19"
    changes:
      - "统一工作流配置"
      - "整合完整的5状态工作流自动化"
      - "优化性能和监控配置"
      - "宪法合规声明更新"
    constitutional_basis_verified: true
    entropy_impact_assessment: "ΔH_sys = -0.03 (符合§100.3)"
    workflow_coverage: "完整5状态工作流整合"

# 宪法合规声明
constitutional_compliance:
  statement: |
    本统一工作流配置严格遵循OpenDoge宪法约束，确保所有工作流操作：
    1. 遵循5状态工作流状态机公理（§102）
    2. 强制执行审批状态转换要求（§103）
    3. 实时监控和优化熵值影响（§102）
    4. 确保Memory Bank作为单一真理源（§101）
    5. 完整记录所有操作和状态转换（§104）

  validation_requirements:
    - "每次状态转换前验证宪法约束"
    - "实时监控熵值变化和合规状态"
    - "定期进行宪法合规审计"
    - "记录所有宪法相关状态转换事件"

# 文件状态
file_status:
  status: "活跃"
  constitutional_level: "T2 标准层 (工作流配置)"
  maintenance_policy: "持续维护，宪法驱动更新"