# 统一钩子系统配置
# 宪法依据: §101单一真理源原则、§104持久化原则、§102状态机公理、§102熵减原则

name: unified-cdd-hooks
version: v2.0.0
description: CDD统一钩子系统配置 - 整合检查点恢复、宪法约束注入、错误处理和状态仪表板功能
type: hooks-configuration
maintainer: 科技部CDD集成团队
constitutional_basis:
  - "§101: 单一真理源原则 - 所有钩子基于Memory Bank"
  - "§104: 持久化原则 - 钩子执行必须记录"
  - "§102: 状态机公理 - 钩子基于工作流状态"
  - "§102: 熵减原则 - 钩子不得增加系统熵值"

# -----------------------------------------------------------------------------
# 钩子定义
# -----------------------------------------------------------------------------

hooks:
  # 检查点智能恢复钩子
  checkpoint_recovery_hook:
    name: checkpoint-recovery-hook
    version: v1.0.0
    description: 智能检测和恢复Claude Code开发会话的检查点
    type: session-recovery-hook
    enabled: true
    priority: 90
    trigger:
      - session_interrupted
      - session_restart
      - manual_recovery_request
    constitutional_basis:
      - "§104: 持久化原则 - 检查点数据必须持久化保存"
      - "§101: 单一真理源原则 - 恢复必须基于正确的检查点源"
      - "§102: 状态机公理 - 恢复必须恢复正确的状态"
      - "§102: 熵减原则 - 恢复过程不得增加系统熵值"
    
    # 检查点检测逻辑
    checkpoint_detection:
      source_priority:
        - "session_state_file"
        - "last_valid_checkpoint"
        - "project_metadata"
        - "entropy_tracking"
        - "constitutional_context"
      
      auto_detection_rules:
        - rule: "session_file_exists"
          condition: "file_exists('session_state.json')"
          priority: 1
        - rule: "checkpoint_age_threshold"
          condition: "checkpoint_age < 3600"
          priority: 2
        - rule: "entropy_consistency"
          condition: "entropy_delta < 0.05"
          priority: 3
        - rule: "constitutional_integrity"
          condition: "constitutional_checks_passed"
          priority: 4
    
    # 检查点管理
    checkpoint_management:
      auto_checkpointing:
        triggers:
          - "constitutional_check_passed"
          - "entropy_check_passed"
          - "module_completed"
          - "time_interval: 15分钟"
          - "significant_change_detected"
      
      checkpoint_retention:
        policy: "tiered_retention"
        tiers:
          - tier: "critical"
            retention: "7天"
            checkpoints: ["宪法检查点", "熵值检查点"]
          - tier: "important"
            retention: "3天"
            checkpoints: ["模块完成检查点", "测试通过检查点"]
          - tier: "normal"
            retention: "1天"
            checkpoints: ["时间间隔检查点", "开发进度检查点"]

  # 宪法约束动态注入钩子
  constitutional_constraint_injection_hook:
    name: constitutional-constraint-injection-hook
    version: v1.0.0
    description: 根据当前项目阶段动态加载和注入宪法约束
    type: constraint-injection-hook
    enabled: true
    priority: 80
    trigger:
      - session_start
      - state_transition
      - constitutional_context_change
      - manual_injection_request
    constitutional_basis:
      - "§101: 单一真理源原则 - 约束必须来自Memory Bank"
      - "§104: 持久化原则 - 约束注入必须记录"
      - "§102: 状态机公理 - 约束基于当前状态"
      - "§102: 熵减原则 - 约束选择必须降低熵值"
    
    # 约束源定义
    constraint_sources:
      primary_source: "memory_bank/t1_axioms/behavior_patterns.md"
      supplementary_sources:
        - "memory_bank/t0_core/basic_law_index.md"
        - "memory_bank/t0_core/operational_law_index.md"
        - "memory_bank/t0_core/tools_law_index.md"
        - "departments/technology/skills/cdd/reference/"
    
    # 约束分类
    constraint_categories:
      development_constraints:
        - "§101: 单一真理源原则"
        - "§102: 熵减原则"
        - "§119: 主题驱动开发公理"
        - "§310: 零停机协议公理"
        - "§309: Claude Code自动化任务原则"
        - "§304: L2+项目强制使用原则"
      
      operational_constraints:
        - "§108: 异构模型策略公理"
        - "§108.1: 模型参数强制指定子原则"
        - "§112: 配额调度公理"
        - "§126: 人才把关原则"
        - "§127: Agent激活确认公理"
      
      quality_constraints:
        - "§104: 持久化原则"
        - "§300.3: 4门宪法审计"
        - "§200: 孢子隔离原则"
        - "§308: 防御性外交原则"

  # 错误处理与恢复钩子
  error_handling_recovery_hook:
    name: error-handling-recovery-hook
    version: v1.0.0
    description: 智能错误检测、分类、处理和恢复机制
    type: error-recovery-hook
    enabled: true
    priority: 100
    trigger:
      - error_detected
      - exception_thrown
      - constitutional_violation
      - system_failure
      - performance_degradation
    constitutional_basis:
      - "§104: 持久化原则 - 所有错误必须记录"
      - "§102: 熵减原则 - 错误处理不得增加系统熵值"
      - "§102: 状态机公理 - 恢复必须回到有效状态"
      - "§101: 单一真理源原则 - 错误分析基于Memory Bank"
    
    # 错误分类体系
    error_categories:
      constitutional_errors:
        severity_levels:
          - "critical"
          - "severe"
          - "moderate"
          - "minor"
        error_types:
          - "§101_violation"
          - "§102_violation"
          - "constraint_violation"
          - "audit_failure"
          - "permission_boundary_breach"
      
      technical_errors:
        severity_levels:
          - "fatal"
          - "error"
          - "warning"
          - "info"
        error_types:
          - "runtime_exception"
          - "system_error"
          - "network_failure"
          - "resource_exhaustion"
          - "configuration_error"
      
      workflow_errors:
        severity_levels:
          - "severe"
          - "moderate"
          - "minor"
        error_types:
          - "state_transition_failure"
          - "validation_failure"
          - "approval_failure"
          - "completion_failure"
    
    # 错误处理策略
    error_handling_strategies:
      constitutional_errors:
        critical: "立即停止，强制宪法审计"
        severe: "阻止操作，记录审计事件"
        moderate: "记录警告，允许有限继续"
        minor: "记录信息，继续操作"
      
      technical_errors:
        fatal: "会话中断，系统级恢复"
        error: "操作回滚，技术修复"
        warning: "记录警告，继续操作"
        info: "记录信息，不影响操作"
      
      workflow_errors:
        severe: "状态回滚，重新验证"
        moderate: "修正工作流，继续"
        minor: "记录信息，继续工作流"

  # 项目状态仪表板钩子
  project_status_dashboard_hook:
    name: project-status-dashboard-hook
    version: v1.0.0
    description: 在Claude Code界面显示实时项目状态仪表板
    type: status-dashboard-hook
    enabled: true
    priority: 70
    trigger:
      - session_start
      - state_transition
      - status_change
      - manual_dashboard_request
      - time_interval: 30秒
    constitutional_basis:
      - "§104: 持久化原则 - 状态数据必须持久化记录"
      - "§102: 熵减原则 - 实时监控熵值状态"
      - "§102: 状态机公理 - 显示当前工作流状态"
      - "§101: 单一真理源原则 - 状态数据来自Memory Bank"
    
    # 仪表板配置
    dashboard_config:
      refresh_interval: 30
      data_sources:
        primary: "memory_bank/t0_core/active_context.md"
        supplementary:
          - "memory/entropy_history.json"
          - "memory/latest_entropy.json"
          - "memory/agent_activation_log.json"
          - "departments/technology/skills/cdd/claude_integration/status/"
      
      display_sections:
        - "entropy_status"
        - "constitutional_compliance"
        - "workflow_progress"
        - "project_health"
        - "resource_usage"
        - "recent_events"
    
    # 仪表板数据收集
    data_collection:
      entropy_data:
        sources:
          - "real_time_measurement"
          - "historical_trend"
          - "threshold_comparison"
        metrics:
          - "current_entropy"
          - "entropy_delta"
          - "entropy_trend"
          - "hotspot_analysis"

# -----------------------------------------------------------------------------
# 钩子执行顺序和依赖
# -----------------------------------------------------------------------------

hook_execution_order:
  session_start_sequence:
    - "project_status_dashboard_hook"
    - "constitutional_constraint_injection_hook"
    - "checkpoint_recovery_hook"
    - "error_handling_recovery_hook"
  
  state_transition_sequence:
    - "constitutional_constraint_injection_hook"
    - "project_status_dashboard_hook"
    - "checkpoint_recovery_hook"
  
  error_handling_sequence:
    - "error_handling_recovery_hook"
    - "project_status_dashboard_hook"
    - "checkpoint_recovery_hook"

# -----------------------------------------------------------------------------
# 性能配置
# -----------------------------------------------------------------------------

performance_configuration:
  hook_execution_timeout: 30  # 秒
  concurrent_hook_limit: 2
  
  caching:
    enabled: true
    cache_duration: 300  # 秒
    cache_invalidation:
      triggers:
        - "constitutional_change"
        - "state_transition"
        - "manual_invalidation"

# -----------------------------------------------------------------------------
# 监控与审计
# -----------------------------------------------------------------------------

monitoring_and_audit:
  hook_execution_monitoring:
    metrics:
      - "execution_success_rate"
      - "execution_time"
      - "error_rate"
      - "cache_hit_rate"
    
    thresholds:
      success_rate_warning: 90%
      success_rate_critical: 80%
      execution_time_warning: "2秒"
      execution_time_critical: "5秒"
  
  constitutional_audit_points:
    audit_triggers:
      - "hook_initialization"
      - "hook_execution"
      - "hook_error"
    
    audit_requirements:
      - "钩子执行宪法合规检查"
      - "熵值影响评估"
      - "审计日志记录"

# -----------------------------------------------------------------------------
# 版本历史
# -----------------------------------------------------------------------------

version_history:
  v2.0.0:
    date: "2026-02-19"
    changes:
      - "统一钩子系统配置"
      - "整合检查点恢复、宪法约束注入、错误处理和状态仪表板"
      - "性能优化和监控增强"
      - "宪法合规声明更新"
    constitutional_basis_verified: true
    entropy_impact_assessment: "ΔH_sys = -0.02 (符合§100.3)"
    hook_coverage: "完整钩子系统整合"

# 宪法合规声明
constitutional_compliance:
  statement: |
    本统一钩子配置严格遵循OpenDoge宪法约束，确保所有钩子操作：
    1. 基于Memory Bank作为单一真理源（§101）
    2. 降低或维持系统熵值（§102）
    3. 支持5状态工作流完整执行（§102）
    4. 持久化记录所有操作（§104）
    5. 提供智能错误处理和恢复（§104）

  validation_requirements:
    - "每次钩子执行前验证宪法约束"
    - "实时监控宪法合规状态"
    - "定期进行宪法合规审计"
    - "记录所有宪法相关事件"

# 文件状态
file_status:
  status: "活跃"
  constitutional_level: "T2 标准层 (集成配置)"
  maintenance_policy: "持续维护，宪法驱动更新"